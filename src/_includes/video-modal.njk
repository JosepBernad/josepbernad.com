<!-- Video Modal -->
<div class="video-modal" id="videoModal" onclick="closeModal(event)">
  <div class="video-modal-wrapper" onclick="event.stopPropagation()">
    <button class="video-modal-close" onclick="closeModal()">&times;</button>
    <div class="video-modal-content">
      <media-player id="videoPlayer" crossorigin playsinline>
        <media-provider></media-provider>
        <media-video-layout thumbnails="" no-title></media-video-layout>
      </media-player>
      <!-- Splash screen while video loads -->
      <div class="video-splash" id="videoSplash">
        <svg class="video-splash-logo" viewBox="0 0 400 498" width="400" height="498" xmlns="http://www.w3.org/2000/svg">
          <path fill="#d1d2d3" d="m367.28 206.84q-25.5-24.47-71.45-32.48v-1.99c13.68-2.66 25.88-7.58 36.72-14.73 10.84-7.17 19.39-15.82 25.73-26q9.47-15.22 9.48-33.21 0.01-21.98-12.98-41.46-12.99-19.49-40.96-31.73-27.97-12.23-73.92-12.24h-1.79-6.39-155.81c-1.36 0-2.47 1.11-2.47 2.47v15.64c0 1.37 1.11 2.47 2.47 2.47h36.44q1.54 3.42 2.83 10.15 1.72 9.23 1.73 28.72v214.32q0.01 11.98-0.48 32.72-0.5 20.74-1.99 43.71c-1.03 15.32-2.51 29.64-4.5 42.97q-3.03 19.97-8 30.47c-2.32 4.32-5.34 7.99-8.99 10.99-3.69 2.99-8.67 4.5-15.01 4.5q-8.97-0.01-22.97-3.25-14-3.25-24.96-9.75-22.01 8.49-22.01 27.49 0.01 7.48 5.27 11.48 5.27 3.99 11.47 5.24c4.16 0.83 7.45 1.25 9.77 1.25 18.62 0 35.8-3.83 51.43-11.48 15.67-7.67 29.39-17.99 41.22-30.97 11.84-13 21.05-27.49 27.73-43.47q8.5-20.98 10.98-50.95c1.7-19.99 2.51-41.8 2.51-65.45v-231.29q-0.01-12.26 3.57-17.4h59.77c18.22 0.71 33.66 3.63 45.12 9.65q19.51 10.24 28.24 25.98 8.74 15.74 8.74 33.22-0.01 15.98-8.48 30.47-8.51 14.49-25.48 23.23c-9.86 5.07-37.6 7.81-45.86 8.41-1.29 0.09-2.28 1.17-2.28 2.46v15.31c0 1.27 0.98 2.33 2.25 2.45 14.61 1.39 27.88 3.25 38.37 6.1q23.99 6.49 36.98 16.97c8.67 6.99 14.64 14.99 17.99 23.99q4.98 13.49 4.98 28.98-0.01 28.97-21.2 48.2c-14.19 12.82-35.58 19.23-64.22 19.23h-15.15-37.44c-1.31 0-2.39 1.03-2.46 2.34q-0.42 7.69-0.99 14.99c-0.11 1.43 1.02 2.65 2.46 2.65h38.43 18.65q45.46 0.01 77.2-12.24 31.69-12.22 48.45-32.22 16.75-19.97 16.74-42.95 0.01-29.48-25.48-53.96z"/>
        </svg>
      </div>
      <!-- Mobile: plain YouTube iframe (hidden on desktop) -->
      <iframe class="video-mobile-iframe" id="videoMobileIframe" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen frameborder="0"></iframe>
      <!-- YouTube-style play/pause visual feedback overlay -->
      <div class="play-pause-feedback" id="playPauseFeedback">
        <svg class="feedback-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        <svg class="feedback-pause" viewBox="0 0 24 24" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
      </div>
    </div>
    <div class="video-modal-info">
      <div class="video-modal-info-left">
        <div class="video-modal-title" id="videoTitleOverlay"></div>
        <div class="video-modal-tags" id="videoModalTags"></div>
      </div>
      <div class="video-modal-info-right">
        <div class="video-modal-location" id="videoModalLocation"></div>
        <div class="video-modal-date" id="videoModalDate"></div>
      </div>
    </div>
    <div class="video-modal-recs" id="videoModalRecs">
      {% for film in films.items %}
      <article class="video-rec-card" data-video-id="{{ film.videoId }}" data-title="{{ film.title }}" data-tags='{{ film.tags | dump | safe }}' data-location="{{ film.location }}" data-date="{{ film.date }}">
        <div class="video-rec-thumb">
          <img src="https://img.youtube.com/vi/{{ film.videoId }}/hqdefault.jpg" alt="{{ film.title }}" loading="lazy">
        </div>
        <div class="video-rec-info">
          <span class="video-rec-title">{{ film.title }}</span>
          <span class="video-rec-meta">{{ film.location }}</span>
        </div>
      </article>
      {% endfor %}
    </div>
  </div>
</div>

<script type="module">
  let player = null;
  let firstPlay = true;
  let splashShownAt = 0;
  const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

  function setTitle(el, text) {
    const parts = text.split('|');
    if (parts.length > 1) {
      el.innerHTML = `<span class="video-modal-title-main">${parts[0].trim()}</span> <span class="video-modal-title-sub">${parts.slice(1).join('|').trim()}</span>`;
    } else {
      el.innerHTML = `<span class="video-modal-title-main">${text}</span>`;
    }
  }

  customElements.whenDefined('media-player').then(() => {
    player = document.getElementById('videoPlayer');

    const feedback = document.getElementById('playPauseFeedback');
    const feedbackPlay = feedback.querySelector('.feedback-play');
    const feedbackPause = feedback.querySelector('.feedback-pause');

    player.addEventListener('started', () => {
      const splash = document.getElementById('videoSplash');
      const elapsed = Date.now() - splashShownAt;
      const remaining = Math.max(0, 2000 - elapsed);
      setTimeout(() => splash.classList.add('fade-out'), remaining);
    });

    player.addEventListener('play', () => {
      if (firstPlay) { firstPlay = false; return; }
      feedbackPlay.style.display = '';
      feedbackPause.style.display = 'none';
      showFeedback();
    });

    player.addEventListener('pause', () => {
      feedbackPlay.style.display = 'none';
      feedbackPause.style.display = '';
      showFeedback();
    });

    function showFeedback() {
      feedback.classList.remove('animate');
      void feedback.offsetWidth;
      feedback.classList.add('animate');
    }
  });

  window.openVideo = function(videoId, title, tags, location, date) {
    const modal = document.getElementById('videoModal');
    modal.classList.add('active');
    document.documentElement.style.overflow = 'hidden';
    document.body.style.overflow = 'hidden';

    const splash = document.getElementById('videoSplash');
    if (isMobile) {
      splash.classList.add('fade-out');
    } else {
      splash.classList.remove('fade-out');
      splashShownAt = Date.now();
    }

    const titleEl = document.getElementById('videoTitleOverlay');
    setTitle(titleEl, title || '');

    const tagsContainer = document.getElementById('videoModalTags');
    tagsContainer.innerHTML = (tags || []).map(t => `<span class="video-modal-tag">${t}</span>`).join('');

    document.getElementById('videoModalLocation').textContent = location || '';
    if (date) {
      const [year, month] = date.split('-');
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      document.getElementById('videoModalDate').textContent = `${monthNames[parseInt(month, 10) - 1]} ${year}`;
    } else {
      document.getElementById('videoModalDate').textContent = '';
    }

    // Highlight active recommendation
    document.querySelectorAll('.video-rec-card').forEach(card => {
      card.classList.toggle('active', card.dataset.videoId === videoId);
    });

    if (isMobile) {
      const iframe = document.getElementById('videoMobileIframe');
      iframe.src = `https://www.youtube.com/embed/${videoId}?rel=0&playsinline=1&modestbranding=1`;
    } else if (player) {
      firstPlay = true;
      const onTitleChange = () => {
        if (player.title) setTitle(titleEl, player.title);
        player.removeEventListener('title-change', onTitleChange);
      };
      player.addEventListener('title-change', onTitleChange);
      const onCanPlay = () => {
        player.play();
        player.removeEventListener('can-play', onCanPlay);
      };
      player.addEventListener('can-play', onCanPlay);
      player.src = `youtube/${videoId}`;
    }
  }

  window.closeModal = function(event) {
    if (event && event.target !== event.currentTarget) return;
    const modal = document.getElementById('videoModal');
    modal.classList.remove('active');
    document.documentElement.style.overflow = '';
    document.body.style.overflow = '';
    if (isMobile) {
      const iframe = document.getElementById('videoMobileIframe');
      setTimeout(() => { iframe.src = ''; }, 500);
    } else if (player) {
      player.pause();
      setTimeout(() => { player.src = ''; }, 500);
    }
  }

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') window.closeModal();
  });

  // Attach click handlers to page cards (not rec cards inside the modal)
  document.querySelectorAll('[data-video-id]:not(.video-rec-card)').forEach(card => {
    card.addEventListener('click', () => {
      window.openVideo(
        card.dataset.videoId,
        card.dataset.title,
        JSON.parse(card.dataset.tags || '[]'),
        card.dataset.location,
        card.dataset.date
      );
    });
  });

  // Attach click handlers to recommendation cards
  document.querySelectorAll('.video-rec-card').forEach(card => {
    card.addEventListener('click', () => {
      window.openVideo(
        card.dataset.videoId,
        card.dataset.title,
        JSON.parse(card.dataset.tags || '[]'),
        card.dataset.location,
        card.dataset.date
      );
    });
  });
</script>
